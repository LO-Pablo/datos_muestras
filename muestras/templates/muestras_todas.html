{% extends "master.html" %}

{% block title %}
Lista de Muestras
{% endblock %}
{% load static %}
{% block content %}
<link rel ="stylesheet" href="{% static 'muestras_todas.css' %}">


{% load muestras_filters %}
<div class="collapsible">
    <button class="collapsible-header">üîç Filtros</button>
    <div class="collapsible-content">
<div class="filter-panel">
    <form action="" id="filter-form">
        <div class="filter-grid">

            {% for field in field_names %} 
            <div class="filter-field">
                <label>{{ field_names_readable_dict|get_item:field }}</label>

                {% if "fecha" in field %}
                    <input type="date" name="{{field}}">
                {% else %}
                    <input type="text" name="{{field}}">
                {% endif %}
            </div>
            {% endfor %}

            <div class="filter-field">
                <label>Estudio</label>
                <input type="text" name="estudio">
            </div>
            <div class="filter-field">
            <label>Estado actual</label>
                <select name="estado_actual">
                  <option value=""></option>
                  <option value="Disponible">Disponible</option>
                  <option value="Parcialmente enviada">Parcialmente enviada</option>
                  <option value="Enviada">Enviada</option>
                  <option value="Destruida">Destruida</option>
                </select>
            </div>
        </div>

        <div class="filter-buttons">
            <button type="submit" class="btn btn-primary">
                üîé Filtrar
            </button>
              <a href="/muestras" class="btn btn-secondary">
                ‚úñ Eliminar filtros
            </a>
        </div>
    </form>
</div>
</div>
</div>

<div class="collapsible">
    <button class="collapsible-header">‚öôÔ∏è Acciones</button>
    <div class="collapsible-content">
 <div class="action-buttons">
   {% if perms.muestras.can_add_muestras_web %}
    <a href="/muestras/nueva" class="btn">
      ‚ûïüß™ Nueva muestra
    </a>
    <a href="/muestras/upload_excel" class="btn">
      üì§üìÑ Subir Excel
    </a>
    {% endif %}

    <input type="button" value="‚òëÔ∏è Seleccionar todo" onclick="seleccionar_todo(true)" class="btn btn-secondary">
    <input type="button" value="‚òê Deseleccionar" onclick="seleccionar_todo(false)" class="btn btn-secondary">

    <form action="" method="GET" style="display:inline;">
        {% for key, value in request.GET.items %}
            {% if key != 'exportar_excel' %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
        {% endfor %}
        <button name="exportar_excel" value="exportar_excel" type="submit" class="btn btn-success">
          üìä‚¨á Exportar Excel
        </button>
    </form>
    <script language="JavaScript">
      function seleccionar_todo(valor) {
        checkboxes = document.getElementsByTagName('input');
        for (var i=0; i<checkboxes.length; i++) {
          if (checkboxes[i].type == 'checkbox')
            checkboxes[i].checked = valor;
        }
      }
    </script>
   <form action="{% url 'acciones_post' %}" method="post">
    {%csrf_token%}
    {% if perms.muestras.can_delete_muestras_web %}
    <button type="submit"  value = "true" id='eliminar' name ='eliminar' onclick="return confirm('¬øQuieres eliminar las muestras seleccionadas?')"class="btn btn-danger">üóëÔ∏è Eliminar seleccionadas</button>
    {%endif%}
    {% if perms.muestras.can_change_estudios_web %}
    <button type="submit" value="true" id='estudio' name ='estudio'class="btn">üß¨ A√±adir al estudio</button>
    <button type="submit" value="true" id='destruir' name ='destruir' onclick="return confirm('¬øQuieres actualizar el estado de las muestras seleccionadas a Destruida?')" class="btn btn-danger">üî• Destruir muestra</button>
    {%endif%}
    {% if perms.muestras.can_change_muestras_web %}
    <button type="submit"  value="true" id='envio' name ='envio' class="btn btn-success">üì¶ Registrar env√≠o</button>
    {%endif%}
 </div>
 </div>
</div>


<!--
<form action="" method="GET" style="display:inline;">
    {% for key, value in request.GET.items %}
        {% if key != 'crear_pdf' %}
            <input type="hidden" name="{{ key }}" value="{{ value }}">
        {% endif %}
    {% endfor %}
    <input name="crear_pdf" type="submit" class="btn btn-success" value="Crear PDF de la B√∫squeda">
</form>
-->


<div class="table-container">
  <table class="styled-table">
    <thead>
      <tr>
        <th>Seleccionar</th>
        <th class="wrap-text">ID Individuo</th>
        <th>Nombre</th>
        <th>Localizaci√≥n</th>
        <th class="wrap-text">Historial de localizaciones</th>
        <th>Material</th>
        <th >Volumen</th>
        <th >Concentraci√≥n</th>
        <th >Masa</th>
        <th>Fecha de extracci√≥n</th>
        <th>Fecha de llegada</th>
        <th class="wrap-text">Observaciones</th>
        <th>Estado inicial</th>
        <th class="wrap-text">Centro de procedencia</th>
        <th class="wrap-text">Lugar de procedencia</th>
        <th class="wrap-text">Estado actual</th>
        <th>Estudio</th>
        <th class="wrap-text">Historial de estudios</th>
        <th class="wrap-text">Historial de envios</th>
      </tr>
    </thead>
 
  <tbody>
    {% for x in muestras %}
   <tr class="{% if x.estado_actual == 'Disponible' %}status-available{% elif x.estado_actual == 'Parcialmente enviada' %}status-processing{% elif x.estado_actual == 'Destruida' %}status-destroyed{% else %}status-enviada{% endif %}">
      <td><input type="checkbox" name="muestra_id" value ="{{x.id}}" class="form-control"></td>
      <td class="wrap-text">{{ x.id_individuo }}</td>
      <td>{{ x.nom_lab }}</td>
      {% with y=x.localizacion.all %}
      {% if y %}
      {% for y in x.localizacion.all %}
      <td>{{y.congelador}}-{{y.estante}}-{{y.posicion_rack_estante}}-{{y.rack}}-{{y.posicion_caja_rack}}-{{y.caja}}-{{y.subposicion}}</td>
      {% endfor %}
      {% else %}
      <td>Sin localizaci√≥n asignada</td>
      {% endif %}
      {% endwith %}
      <td class="wrap-text"><a href="{%url 'historial_localizaciones' x.id%}">Ver historial de localizaciones</a></td>
      <td>
      {% if x.id_material != None %}
        {{ x.id_material }}
      {%endif%}
      </td>
      <td>
      {%if x.volumen_actual != None %}
        {{ x.volumen_actual}} {{ x.unidad_volumen }}
      {%endif%}
      </td>
      <td>
      {% if x.concentracion_actual != None %}
        {{ x.concentracion_actual }}  {{ x.unidad_concentracion }}
      {%endif%}
      </td>
      <td>
      {% if x.masa_actual != None %}
        {{ x.masa_actual }}  {{ x.unidad_masa }}
      {%endif%}
      </td>
      <td>
      {%if x.fecha_extraccion != None %}
        {{ x.fecha_extraccion }}
      {%endif%}
      </td>
      <td>
      {% if x.fecha_llegada != None %}
        {{ x.fecha_llegada }}
      {%endif%}
      </td>
      <td class="wrap-text">
      {% if x.observaciones != None %}
        {{ x.observaciones }}
      {%endif%}
      </td>
      <td>
      {% if x.estado_inicial != None %}
        {{ x.estado_inicial }}
      {%endif%}
      </td>
      <td class="wrap-text">
      {% if x.centro_procedencia != None %}
        {{ x.centro_procedencia }}
      {% endif %}
      </td>
      <td class="wrap-text">
      {% if x.lugar_procedencia != None %}
        {{ x.lugar_procedencia }}
      {% endif %}
      </td>
      <td class="wrap-text">
      {%if x.estado_actual != None %}
        {{ x.estado_actual }}
      {% endif %}
      </td>
      <td>
      {% if x.estudio != None %}
        {{ x.estudio.nombre_estudio }}
      {% else %}
        Sin estudio asignado
      {% endif %}
    </td>
    <td class="wrap-text">
      <a href="{%url 'historial_estudios' x.id %}">Ver estudios</a>
    </td>
    <td class="wrap-text">{%if x.envio.all%}
      <a href="{% url 'historial_envios' x.id %}">Ver envios</a>
      {%else%}
      Sin envios registrados
      {% endif %}
    </td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
</form>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const headers = document.querySelectorAll(".collapsible-header");

    headers.forEach(header => {
        header.addEventListener("click", function() {
            const content = this.nextElementSibling;

            this.classList.toggle("active");

            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                content.classList.remove("open");
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                content.classList.add("open");
            }
        });
    });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% if messages %}
 {% for message in messages %}
  <script>
      Swal.fire({
        title: '{{ message.tags|capfirst }}',
        text: '{{ message }}',
        icon: '{{ message.tags }}', // 'success', 'error', 'info', 'warning'
        confirmButtonText: 'Aceptar'
      });
  </script>
{% endfor %}
{% endif %}
{% endblock %}