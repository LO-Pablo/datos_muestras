{% extends "master.html" %}

{% block title %}
Confirmaci√≥n subida
{% endblock %}
{% load static %}
<!-- P√°gina de confirmaci√≥n para la subida de un excel para a√±adir muestras -->
 {% block content %}
<link rel ="stylesheet" href="{% static 'forms.css' %}">
<div class="form-container">

    <!-- CABECERA -->
    <div class="form-header">
        {% if numero_errores_bloqueantes > 0 %}
        <h1>‚ùå Problemas con la subida del Excel de de muestras: Fallo cr√≠tico: ERRORES DETECTADOS</h1>

        {% elif numero_errores_advertencia > 0 %}
        <h1>‚ö†Ô∏è Confirmaci√≥n de subida de Excel de muestras: Advertencia</h1>

        {% else %}
        <h1>‚úÖ Confirmaci√≥n de subida de Excel</h1>

        {% endif %}
        <p class="form-subtitle">
            
        </p>
    </div>

    <!-- MENSAJES DEL SISTEMA -->
    {% if messages %}
    <div class="form-card messages-card">
        <h2>üì¢ Mensajes</h2>
        {% for message in messages %}
            <p class="message-item">{{ message }}</p>
        {% endfor %}
    </div>
    {% endif %}

    <!-- EXPLICACI√ìN DE ERRORES -->
    {% if numero_errores_bloqueantes > 0 or numero_errores_advertencia > 0 %}
    <div class="form-card info-card">
        <h2>‚ÑπÔ∏è Resultado de la validaci√≥n del Excel</h2>

        <p>
            Se ha generado un archivo Excel donde se indican los posibles problemas
            encontrados en el archivo original:
        </p>

        <ul class="requirements-list">
            <li>
                <strong style="color:#d32f2f;">Filas en rojo</strong>:
                la muestra ya existe en la base de datos o en el excel, faltan campos obligatorios
                (indicando cu√°l en un comentario), hay un problema con la localizaci√≥n o alg√∫n campo est√° en el formato incorrecto.
            </li>
            <li>
                <strong style="color:#ffa000;">Filas en amarillo</strong>:
                campos no obligatorios vac√≠os, marcados con un comentario. Estudio no existe en la base de datos. 
            </li>
        </ul>
       
    </div>

    

    <!-- DESCARGA EXCEL ERRORES -->
    <div class="form-card">
        <h2>üìÑ Excel de errores</h2>

        <form method="post">
            {% csrf_token %}
            <button name="excel_errores" type="submit" class="accion-btn accion-secundaria">
                ‚¨áÔ∏è Descargar Excel con errores
            </button>
        </form>
        <p style="margin-bottom: 15px;">
        Una vez corregidos los errores, puede vuelver a subir el archivo Excel.
        </p>
        <p class="note warning">
            ‚ö†Ô∏è El Excel de errores <strong>NO debe subirse directamente</strong>
            para a√±adir las muestras.
        </p>
    </div>

    {% endif %}

    <!-- SUBIR OTRO EXCEL -->
    <div class="form-card">
        <h2>üì§ Subir otro archivo Excel</h2>

        <form method="post" enctype="multipart/form-data" class="styled-form">
            {% csrf_token %}

            <div class="form-field">
                <label for="id_excel_file">Excel file <span class="required">*</span></label>
                <input type="file" name="excel_file" accept=".xlsx,.xlsm,.xls" required id="id_excel_file">
                <small class="error-text" style="display: block; color: #dc3545; margin-top: 5px;">Este campo es obligatorio.</small>
            </div>

            <div class="form-actions">
                <button name="upload_excel" id="upload-button" type="submit" class="accion-btn accion-primaria" disabled>
                    ‚¨ÜÔ∏è Subir Excel
                </button>
            </div>
        </form>
    </div>

    <!-- CONFIRMACI√ìN -->
    {% if numero_errores_bloqueantes == 0 %}
    <div class="form-card confirm-card">
        <h2>‚ùì Confirmaci√≥n</h2>
        <p>¬øDesea a√±adir las muestras v√°lidas del archivo Excel?</p>

        <form method="post" class="form-actions">
            {% csrf_token %}

            <button type="submit" name="confirmar" class="accion-btn accion-primaria">
                ‚úÖ Confirmar subida
            </button>

            <button type="submit" name="cancelar" class="accion-btn accion-peligro">
                ‚ùå Cancelar
            </button>
        </form>
    </div>
    {% endif %}

    <!-- VOLVER -->
    <div class="form-actions">
        <a href="/muestras" class="accion-btn accion-secundaria">
            ‚Ü© Volver a muestras
        </a>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const fileInput = document.querySelector('input[name="excel_file"]') || document.querySelector('input[type="file"]');
    const uploadButton = document.getElementById('upload-button');

    function toggleUploadButton() {
        if (!fileInput || !uploadButton) return;
        uploadButton.disabled = !fileInput.files.length;
    }

    if (fileInput && uploadButton) {
        fileInput.addEventListener('change', toggleUploadButton);
        toggleUploadButton();
    }
});
</script>

{% endblock %}
