{% extends "master.html" %}

{% block title %}
Repositorio de documentaci√≥n del estudio {{estudio.id_estudio}}
{% endblock %}
{% load static %}
<!-- P√°gina que muestra el repositorio de documentos asociados a un estudio espec√≠fico -->
{% block content %}
<link rel="stylesheet" href="{% static 'muestras_todas.css' %}">
<div class="form-container">

    <!-- BARRA DE ACCIONES -->
    <div class="acciones-estudios">
        <a href="/" class="accion-btn accion-secundaria">
            ‚¨Ö Volver a muestras
        </a>

        <a href="/estudios" class="accion-btn accion-secundaria">
            üìö Volver a estudios
        </a>

        <a href="/estudios/{{ id }}/subir" class="accion-btn accion-primaria">
            ‚ûï Subir documento
        </a>
    </div>

    <!-- CABECERA -->
    <div class="form-header">
        <h1>üìÇ Documentaci√≥n del estudio {{ estudio.id_estudio }}</h1>
        <p class="form-subtitle">
            Repositorio de archivos asociados a este estudio.
        </p>
    </div>

    <!-- FILTROS -->
    <div class="collapsible">
    <button class="collapsible-header">üîç Filtros</button>
    <div class="collapsible-content">
         <div class="filter-panel">
        <form method="get" id="filtros" class="styled-form">
           <div class="filter-grid">
                <div class="filter-field">
                    <label for="categoria">Categor√≠a</label>
                    <input type="text" name="categoria" id="categoria">
                </div>

                <div class="filter-field">
                    <label for="usuario">Usuario</label>
                    <select name="usuario" id="usuario">
                        <option value="">Todos</option>
                        {% for user in usuarios %}
                            <option value="{{ user.username }}">
                                {{ user.username }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

            <div class="filter-buttons">
                <button type="submit" class="accion-btn accion-secundaria">
                    üîé Filtrar
                </button>

                <a href="/estudios/{{ id }}" class="accion-btn accion-secundaria">
                    ‚úñ Eliminar filtros
                </a>
            </div>
            </div>
        </form>
        </div>
    </div>
    </div>
    <script>
document.addEventListener("DOMContentLoaded", function() {
    const headers = document.querySelectorAll(".collapsible-header");

    headers.forEach(header => {
        header.addEventListener("click", function() {
            const content = this.nextElementSibling;

            this.classList.toggle("active");

            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                content.classList.remove("open");
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                content.classList.add("open");
            }
        });
    });
});
</script>

    <!-- TABLA + FORM DE ELIMINACI√ìN -->
    <form action="{% url 'eliminar_documento' %}" method="post">
        {% csrf_token %}

        <div class="form-actions" style="margin-bottom: 10px;">
            <button type="submit"
                    class="accion-btn accion-peligro"
                    onclick="return confirm('¬øQuieres eliminar los documentos seleccionados?')">
                üóë Eliminar documentos seleccionados
            </button>
        </div>

        <div class="table-container">
            <table class="styled-table">
                <thead>
                    <tr>
                        <th>‚úì</th>
                        <th>Archivo</th>
                        <th>Fecha de subida</th>
                        <th>Categor√≠a</th>
                        <th>Subido por</th>
                        <th>Descripci√≥n</th>
                    </tr>
                </thead>

                <tbody>
                {% for doc in documentos %}
                    <tr>
                        <td>
                            <input type="checkbox"
                                   name="doc_id"
                                   value="{{ doc.id }}">
                        </td>

                        <td>
                            <a href="/estudios/{{ id }}/{{ doc.id }}"
                               class="chip-detalle">
                                ‚¨áÔ∏è Descargar
                            </a>
                        </td>

                        <td>{{ doc.fecha_subida }}</td>
                        <td>{{ doc.categoria }}</td>
                        <td>{{ doc.usuario_subida.username }}</td>
                        <td class="wrap-text">{{ doc.descripcion }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </form>

</div>

{% endblock %}